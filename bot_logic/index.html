<!DOCTYPE html>
<html>
<head>
    <title>Perfume Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap"
    />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="chat-container" id="chat-wrapper">
        <div class="chat-header">
        <img
          src="../img/icons/chevronLeft.svg"
          alt="Back"
          class="back-icon"
          id="back-button"
        />
        <span id="header-text">Bună ziua!<br />Cu ce vǎ putem ajuta?</span>
        </div>
        
        <div class="card-container" id="card-container">
        <div class="card" id="card3">
          <div class="card-title">
            <div class="card-header">Vreau să îmi aleg un parfum</div>
            <img
              src="../img/icons/chevronRight.svg"
              class="chevron-icon"
            />
          </div>
          <div class="chat-content" id="chat-content-3"></div>
        </div>

            <div class="card" id="card1">
                <div class="card-title">
            <div class="card-header">Despre comanda mea</div>
            <img
              src="../img/icons/chevronRight.svg"
              class="chevron-icon"
            />
                </div>
                <div class="chat-content" id="chat-content-1"></div>
            </div>
            
            <div class="card" id="card2">
                <div class="card-title">
            <div class="card-header">Despre cel mai apropiat magazin</div>
            <img
              src="../img/icons/chevronRight.svg"
              class="chevron-icon"
            />
                </div>
                <div class="chat-content" id="chat-content-2"></div>
            </div>
        </div>
        
      <div id="chat-messages" style="display: none"></div>
    </div>
    
    <div class="chat-toggle-button" id="chat-toggle">
      <img
        src="../img/icons/openButton.svg"
        alt="Chat toggle"
        id="toggle-icon"
      />
    </div>
    
    <div class="chat-assistant-label" id="chat-label">
      Asistent vânzǎri AI
    </div>

    <script type="module">
      import ChatbotFlow from "./dp_flow.js";

      class ChatbotInterface {
        constructor(config = {}) {
          // Default configuration
          this.config = {
            headerTitle: "Chat Assistant",
            containerId: "chat-messages",
            wrapperId: "chat-wrapper",
            toggleId: "chat-toggle",
            labelId: "chat-label",
            cardsContainerId: "card-container",
            headerTextId: "header-text",
            backButtonId: "back-button",
            ...config,
          };

          // Initialize UI elements
          this.chatContainer = document.getElementById(this.config.containerId);
          this.chatWrapper = document.getElementById(this.config.wrapperId);
          this.chatToggle = document.getElementById(this.config.toggleId);
          this.chatLabel = document.getElementById(this.config.labelId);
          this.cardContainer = document.getElementById(
            this.config.cardsContainerId
          );
          this.headerText = document.getElementById(this.config.headerTextId);
          this.backButton = document.getElementById(this.config.backButtonId);
          this.chatHeader = document.querySelector(".chat-header");
                
                this.currentFlowId = null;
          this.userId = "user_" + Date.now();

          // Configuration for special question types - maps question IDs to handlers
          this.specialQuestionTypes = {
            "3.2.1": {
              type: "productDropdown",
              dataProvider: "getProductOptions",
            },
            2.1: {
              type: "locationDropdown",
              dataProvider: "getLocationOptions",
            },
          };
                
                // Map each card to its corresponding question ID and answer ID
                this.cardMapping = {
            1: {
              questionId: "1",
              answerId: "1.1",
              text: "Despre comanda mea",
            },
            2: {
              questionId: "1",
              answerId: "2.1",
              text: "Despre cel mai apropiat magazin",
            },
            3: {
              questionId: "1",
              answerId: "3.1",
              text: "Vreau să îmi aleg un parfum",
            },
                };
                
                this.flowLabels = {
            1: "Despre comanda mea",
            2: "Despre cel mai apropiat magazin",
            3: "Vreau să îmi aleg un parfum",
                };
                
                // Check if chat container exists
                if (!this.chatContainer) {
            console.error("Chat container not found!");
                    return;
                }

          // Initialize toggle icon based on initial state
          const toggleIcon = document.getElementById("toggle-icon");
          if (toggleIcon) {
            toggleIcon.src = "../img/icons/closeButton.svg"; // Default to close icon
            // Add rotated class if starting with close icon
            if (toggleIcon.src.includes("closeButton")) {
              this.chatToggle.classList.add("rotated");
            }
          }

                this.setupEventListeners();
                this.initCards();
            }

            async init(flowId) {
                try {
                    this.currentFlowId = flowId;
                    this.showLoading();

            // Initialize the chat flow engine with original method names
            this.chatbot = new ChatbotFlow(this.userId);

            // Use the original method names from the ChatbotFlow implementation
            this.productData =
              await this.chatbot.return_perfumes_brands_and_models();

            // Load questions and conversation flow with original method name
            await this.chatbot.process_questions("questions.json");
                    
                    this.hideLoading();
                    
            // Add today's date at the top of the conversation
            this.addDateHeader();
                    
            // Make sure chat messages container is visible
            this.chatContainer.style.display = "flex";
                    
            // Get the mapping for this flow
                    const mapping = this.cardMapping[flowId];
                    if (mapping) {
              // Process the answer directly without showing the first question
                        this.processAnswer(mapping.questionId, mapping.answerId);
                    }
                } catch (error) {
            console.error("Initialization error:", error);
                    this.hideLoading();
            this.showError("Error initializing chatbot: " + error.message);
                }
            }

            initCards() {
          // Get all cards by their IDs
          const cards = {};
          Object.keys(this.cardMapping).forEach((id) => {
            cards[id] = document.getElementById(`card${id}`);
            if (cards[id]) {
              cards[id].addEventListener("click", () =>
                this.expandCard(cards[id], id)
              );
            }
          });

          // Setup back button
          this.backButton.addEventListener("click", () => this.collapseCard());
            }
            
            expandCard(card, flowId) {
                // Hide other cards
          document.querySelectorAll(".card").forEach((c) => {
                    if (c !== card) {
              c.style.display = "none";
                    }
                });
                
                // Show back button and update header
          this.backButton.style.display = "block";
          this.chatHeader.classList.add("expanded-header");
          this.headerText.textContent = "Meniul principal";

          // Make chat messages container visible immediately
          this.cardContainer.style.display = "none";
          this.chatContainer.style.display = "flex";
          
          // Add class to chat container for mobile style adjustments
          this.chatWrapper.classList.add("card-expanded");
          
          // Initialize the chat with the selected flow ID immediately
                    this.init(flowId);

          // Add expanded class to the card without animation delay
          card.classList.add("expanded");
            }
            
            collapseCard() {
                // Reset UI
          this.chatContainer.style.display = "none";
          this.cardContainer.style.display = "block";
          this.chatHeader.classList.remove("expanded-header");
          this.backButton.style.display = "none";
          this.headerText.textContent = this.config.headerTitle;
                
                // Remove expanded class from chat container
          this.chatWrapper.classList.remove("card-expanded");
                
                // Show all cards again
          document.querySelectorAll(".card").forEach((card) => {
            card.style.display = "flex";
            card.classList.remove("expanded");
                });
                
                // Clear chat messages
          this.chatContainer.innerHTML = "";
                this.currentFlowId = null;
            }

            setupEventListeners() {
          const restartButton = document.getElementById("restart-button");
                if (restartButton) {
            restartButton.addEventListener("click", () => this.restart());
                }

                // Set up chat toggle functionality
                if (this.chatToggle) {
            const toggleIcon = document.getElementById("toggle-icon");
            this.chatToggle.addEventListener("click", () => {
              // Toggle chat visibility
              this.chatWrapper.classList.toggle("hidden");
              this.chatLabel.classList.toggle("visible");
              
              // Toggle the rotation class for animation
              this.chatToggle.classList.toggle("rotated");
              
              // Change the icon based on chat state
              if (this.chatWrapper.classList.contains("hidden")) {
                // Chat is hidden/closed, show open button
                setTimeout(() => {
                  toggleIcon.src = "../img/icons/openButton.svg";
                }, 150); // Wait for half the rotation to change the icon
              } else {
                // Chat is visible/expanded, show close button
                setTimeout(() => {
                  toggleIcon.src = "../img/icons/closeButton.svg";
                }, 150); // Wait for half the rotation to change the icon
              }
                    });
                }
            }

            showLoading() {
                if (!this.chatContainer) return;
                
          const loadingDiv = document.createElement("div");
          loadingDiv.className = "loading system-message";
          loadingDiv.id = "loading-indicator";
          loadingDiv.textContent = "...";
          this.chatContainer.appendChild(loadingDiv);
          this.scrollToBottom();
            }

            hideLoading() {
                if (!this.chatContainer) return;
                
          const loadingDiv = document.getElementById("loading-indicator");
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                
                // Also remove any typing indicators
                this.hideTypingIndicator();
            }

            hideTypingIndicator() {
              if (!this.chatContainer) return;
              
              const typingIndicator = document.getElementById("typing-indicator");
              if (typingIndicator) {
                typingIndicator.remove();
              }
            }

            showError(message) {
                if (!this.chatContainer) return;
                
          const errorDiv = document.createElement("div");
          errorDiv.className = "error system-message";
                errorDiv.textContent = message;
                this.chatContainer.appendChild(errorDiv);
                this.scrollToBottom();
            }

            displayQuestion(questionData) {
                if (!this.chatContainer || !questionData) return;

          // Check if this is a special question type
          const specialConfig = this.specialQuestionTypes[questionData.id];
          if (specialConfig) {
            if (typeof this[specialConfig.dataProvider] === "function") {
              const options = this[specialConfig.dataProvider](questionData);
              this.displayCustomDropdown(questionData, options);
            } else {
              // Fallback to standard display if data provider not found
              this.displayStandardQuestion(questionData);
            }
            return;
          }

          // Default to standard question display
          this.displayStandardQuestion(questionData);
        }

        // Helper function to get a random thinking time between 500ms and 1000ms
        getRandomThinkingTime() {
          return Math.floor(Math.random() * 501) + 500; // Random between 500-1000ms
        }

        displayStandardQuestion(questionData) {
          const questionDiv = document.createElement("div");
          questionDiv.className = "question";
          questionDiv.textContent = questionData.text;
          this.chatContainer.appendChild(questionDiv);

          // Regular answer buttons
          const answersDiv = document.createElement("div");
          answersDiv.className = "message-options";
          questionData.answers.forEach((answer) => {
            const button = document.createElement("button");
            button.className = "answer-button";
            button.textContent = answer.text;
            button.addEventListener("click", () => {
              // Remove all answer buttons when one is selected
              const messageOptions =
                this.chatContainer.querySelectorAll(".message-options");
              messageOptions.forEach((optionDiv) => {
                optionDiv.remove();
              });
                            
              // Add the user's selection as a message
              const userMessageDiv = document.createElement("div");
              userMessageDiv.className = "user-message";
              userMessageDiv.textContent = answer.text;
              this.chatContainer.appendChild(userMessageDiv);
              
              // Scroll to bottom to show user's choice
              this.scrollToBottom();

              // Show typing indicator
              this.showTypingIndicator();
              
              // Get random thinking time
              const thinkingTime = this.getRandomThinkingTime();

              // Add a delay before processing the answer to make conversation feel more organic
              setTimeout(() => {
                // Hide typing indicator before showing the response
                this.hideTypingIndicator();
                
                // Process the answer and continue the flow
                this.processAnswer(questionData.id, answer.id);
              }, thinkingTime);
            });
            answersDiv.appendChild(button);
          });
          this.chatContainer.appendChild(answersDiv);
          this.scrollToBottom();
        }

        // Get product options for dropdown - can be overridden for specific product types
        getProductOptions(questionData) {
          if (!this.productData || !Array.isArray(this.productData)) {
            return [];
          }

          return this.productData.map((item) => ({
            id: `${item.brand}-${item.model}`,
            text: `${item.brand} ${item.model}`,
            data: {
              brand: item.brand,
              model: item.model,
            },
          }));
        }

        // Get location options for dropdown
        getLocationOptions(questionData) {
          if (!questionData.answers || !Array.isArray(questionData.answers)) {
            return [];
          }

          return questionData.answers.map((answer) => ({
            id: answer.id,
            text: answer.text,
          }));
        }

        // Generic dropdown display for any type of data
        displayCustomDropdown(questionData, options) {
          if (!this.chatContainer || !options) return;

          // Create a system message container
          const messageDiv = document.createElement("div");
          messageDiv.className = "system-message";

          // Add the message text
          const textSpan = document.createElement("div");
          textSpan.className = "message-text";
          textSpan.textContent = questionData.text;
          messageDiv.appendChild(textSpan);

          // Create custom dropdown container
          const dropdownContainer = document.createElement("div");
          dropdownContainer.className = "custom-dropdown-container";

          // Create input for filtering
          const inputField = document.createElement("input");
          inputField.type = "text";
          inputField.className = "dropdown-input";
          inputField.placeholder = "";

          // Create dropdown list container
          const dropdownList = document.createElement("div");
          dropdownList.className = "dropdown-list";

          // Add input and dropdown to the container
          dropdownContainer.appendChild(inputField);
          dropdownContainer.appendChild(dropdownList);

          // Add the dropdown container to the message
          messageDiv.appendChild(dropdownContainer);

          // Add the message to the chat
          this.chatContainer.appendChild(messageDiv);

          // Focus on the input field
          setTimeout(() => inputField.focus(), 100);

          // Track the selected option
          let selectedOption = null;

          // Function to render the options based on filter
          const renderOptions = (filter = "") => {
            // Only show dropdown if filter has content
            if (filter.length > 0) {
              dropdownList.classList.add("active");

              dropdownList.innerHTML = "";

              // Filter options based on text
              const filteredOptions = options.filter((option) =>
                option.text.toLowerCase().includes(filter.toLowerCase())
              );

              // If there are no matching options
              if (filteredOptions.length === 0) {
                const noResult = document.createElement("div");
                noResult.className = "dropdown-no-result";
                noResult.textContent = "Niciun rezultat găsit";
                dropdownList.appendChild(noResult);
              } else {
                // Create filtered options
                filteredOptions.forEach((option) => {
                  const optionElement = document.createElement("div");
                  optionElement.className = "dropdown-option";
                  optionElement.textContent = option.text;

                  // Check if this is the selected option
                  if (selectedOption && selectedOption.id === option.id) {
                    optionElement.classList.add("selected");
                  }

                  // Handle option selection
                  optionElement.addEventListener("click", () => {
                    // Update the selected option
                    selectedOption = option;

                    // Update input field with selected option
                    inputField.value = option.text;

                    // Hide dropdown
                    dropdownList.classList.remove("active");

                    // Add the user's selection as a message and process it
                    setTimeout(() => {
                      // Remove the dropdown container
                      messageDiv.removeChild(dropdownContainer);

                      // Add the user's selection as a message
                      const userMessageDiv = document.createElement("div");
                      userMessageDiv.className = "user-message";
                      userMessageDiv.textContent = option.text;
                      this.chatContainer.appendChild(userMessageDiv);
                      
                      // Scroll to bottom to show user's choice
                      this.scrollToBottom();
                      
                      // Show typing indicator
                      this.showTypingIndicator();
                      
                      // Get random thinking time
                      const thinkingTime = this.getRandomThinkingTime();

                      // Add a delay before processing to make the conversation feel more organic
                      setTimeout(() => {
                        // Hide typing indicator before showing the response
                        this.hideTypingIndicator();
                        
                        // Process the answer based on the question type
                        this.handleSpecialQuestionAnswer(questionData.id, option);
                      }, thinkingTime);
                    }, 300);
                  });

                  dropdownList.appendChild(optionElement);
                });
              }
            } else {
              // Hide dropdown when input is empty
              dropdownList.classList.remove("active");
            }

            // Scroll to the bottom of chat
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
          };

          // Handle input changes to filter options
          inputField.addEventListener("input", () =>
            renderOptions(inputField.value)
          );

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (!dropdownContainer.contains(e.target)) {
              dropdownList.classList.remove("active");
            }
          });

          // Scroll to the bottom of chat
          this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
        }

        // Handle answers for special question types
        handleSpecialQuestionAnswer(questionId, option) {
          const specialConfig = this.specialQuestionTypes[questionId];

          if (!specialConfig) {
            // Regular question - just process the answer with the option ID
            this.processAnswer(questionId, option.id);
            return;
          }

          // Handle different question types
          switch (specialConfig.type) {
            case "productDropdown":
              // Process product selection with additional data
              this.processAnswer(
                questionId,
                "recommendation_model_brand",
                option.data
              );
              break;
            case "locationDropdown":
            default:
              // Process regular option selection
              this.processAnswer(questionId, option.id);
              break;
          }
        }

        displayProductRecommendations(products, systemMessageContainer = null) {
          if (!this.chatContainer || !products) return;

          // Create a new system message container if one wasn't provided
          let recsDiv;
          if (systemMessageContainer) {
            // Use the existing system message container
            recsDiv = systemMessageContainer;
          } else {
            // Create a new system message container
            recsDiv = document.createElement("div");
            recsDiv.className = "system-message";
            this.chatContainer.appendChild(recsDiv);
          }

          // Handle the products object or array
          const productArray = Array.isArray(products)
            ? products
            : Object.values(products);
            
          // Check if there's only one product
          const hasSingleProduct = productArray.length === 1;

          // Create a carousel container that will hold the products and navigation
          const carouselContainer = document.createElement("div");
          carouselContainer.className = "carousel-container";
          if (hasSingleProduct) {
            carouselContainer.classList.add("single-product");
          }
          
          // Create left arrow navigation (only if more than one product)
          if (!hasSingleProduct) {
            const leftArrow = document.createElement("div");
            leftArrow.className = "carousel-arrow carousel-arrow-left";
            leftArrow.innerHTML = "&#10094;"; // Left arrow character
            carouselContainer.appendChild(leftArrow);
          }
          
          // Create the products container
          const productRecsContainer = document.createElement("div");
          productRecsContainer.className = "product-recommendations";
          if (hasSingleProduct) {
            productRecsContainer.classList.add("single-product");
          }

          productArray.forEach((product) => {
            const productDiv = document.createElement("div");
            productDiv.className = "product-item";
            if (hasSingleProduct) {
              productDiv.classList.add("full-width");
            }

            // Create the image container
            const imageContainer = document.createElement("div");
            imageContainer.className = "product-image";
            
            // Set background image instead of creating an img element
            imageContainer.style.backgroundImage = `url(${product.link_pic})`;
            
            // Extract product code from the name (assuming format includes code like A19)
            const productCode = product.name.split(' ')[0]; // Get first word as code
            
            // Create the name/price container
            const nameContainer = document.createElement("div");
            nameContainer.className = "product-name";
            
            // Add product code
            const codeSpan = document.createElement("span");
            codeSpan.textContent = productCode;
            nameContainer.appendChild(codeSpan);
            
            // Add price (hardcoded as example, update with real price if available)
            const priceSpan = document.createElement("span");
            priceSpan.className = "product-price";
            priceSpan.textContent = "90,00 lei"; 
            nameContainer.appendChild(priceSpan);
            
            // Create add to cart button
            const addButton = document.createElement("a");
            addButton.href = product.link;
            addButton.target = "_blank";
            addButton.className = "product-add-button";
            addButton.textContent = "VEZI PRODUS";

            // Add all elements to the product div
            productDiv.appendChild(imageContainer);
            productDiv.appendChild(nameContainer);
            productDiv.appendChild(addButton);

            // Add the product div to the recommendations container
            productRecsContainer.appendChild(productDiv);
          });
          
          // Add the products container to the carousel
          carouselContainer.appendChild(productRecsContainer);
          
          // Create right arrow navigation (only if more than one product)
          if (!hasSingleProduct) {
            const rightArrow = document.createElement("div");
            rightArrow.className = "carousel-arrow carousel-arrow-right";
            rightArrow.innerHTML = "&#10095;"; // Right arrow character
            carouselContainer.appendChild(rightArrow);
          }
          
          // Add carousel to the system message container
          recsDiv.appendChild(carouselContainer);
          
          // Set up carousel navigation if we have more than one product
          if (!hasSingleProduct) {
            this.setupCarouselNavigation(
              carouselContainer.querySelector('.carousel-arrow-left'),
              carouselContainer.querySelector('.carousel-arrow-right'),
              productRecsContainer
            );
          }
          
          // Ensure the latest content is visible
          this.scrollToBottom();
          
          return recsDiv;
        }
        
        // Set up carousel navigation with arrow controls
        setupCarouselNavigation(leftArrow, rightArrow, container) {
          if (!container || !leftArrow || !rightArrow) return;
          
          // Default scroll amount (one product width + gap)
          const scrollAmount = 195; // 180px product width + 15px gap
          
          // Left arrow click handler
          leftArrow.addEventListener('click', () => {
            container.scrollBy({
              left: -scrollAmount,
              behavior: 'smooth'
            });
          });
          
          // Right arrow click handler
          rightArrow.addEventListener('click', () => {
            container.scrollBy({
              left: scrollAmount,
              behavior: 'smooth'
            });
          });
          
          // Show/hide arrows based on scroll position
          const updateArrowVisibility = () => {
            // Show left arrow only if not at the start
            leftArrow.style.opacity = container.scrollLeft > 0 ? '1' : '0.3';
            
            // Show right arrow only if not at the end
            const maxScrollLeft = container.scrollWidth - container.clientWidth;
            rightArrow.style.opacity = container.scrollLeft < maxScrollLeft - 10 ? '1' : '0.3';
          };
          
          // Initial arrow visibility
          updateArrowVisibility();
          
          // Update arrow visibility on scroll
          container.addEventListener('scroll', updateArrowVisibility);
            }

            processAnswer(questionId, answerId, additionalData = null) {
          if (!this.chatbot) return;

                try {
                    // Pass the additional data to processAnswer if it exists
                    const result = additionalData 
              ? this.chatbot.processAnswer(questionId, answerId, additionalData)
              : this.chatbot.processAnswer(questionId, answerId);

                    if (result === null) {
              const endDiv = document.createElement("div");
              endDiv.className = "system-message";
              endDiv.textContent =
                'Conversation ended. Click "Restart" to begin again or go back to select another option.';
              this.chatContainer.appendChild(endDiv);
              this.scrollToBottom();
                    } else {
                        console.log(result);
                        
              // Check if we have product recommendations to include in the system message
                        if (result.system_options && result.system_options.output_list) {
                // Create a system message that will contain both the question and product recommendations
                const systemMessageDiv = document.createElement("div");
                systemMessageDiv.className = "system-message";
                
                // Add question text first
                const textDiv = document.createElement("div");
                textDiv.className = "message-text";
                textDiv.textContent = result.question.text;
                systemMessageDiv.appendChild(textDiv);
                
                // Add the system message to the chat container
                this.chatContainer.appendChild(systemMessageDiv);
                
                // Add product recommendations to the same system message
                this.displayProductRecommendations(result.system_options.output_list, systemMessageDiv);
                
                // Now display any answer options if they exist
                if (result.question.answers && Object.keys(result.question.answers).length > 0) {
                  const answersDiv = document.createElement("div");
                  answersDiv.className = "message-options";
                  
                  Object.entries(result.question.answers).forEach(([id, answer]) => {
                    const button = document.createElement("button");
                    button.className = "answer-button";
                    button.textContent = answer.text;
                    button.addEventListener("click", () => {
                      // Remove all answer buttons when one is selected
                      const messageOptions = this.chatContainer.querySelectorAll(".message-options");
                      messageOptions.forEach((optionDiv) => {
                        optionDiv.remove();
                      });
                      
                      // Add the user's selection as a message
                      const userMessageDiv = document.createElement("div");
                      userMessageDiv.className = "user-message";
                      userMessageDiv.textContent = answer.text;
                      this.chatContainer.appendChild(userMessageDiv);
                      
                      // Scroll to bottom to show the user's choice
                      this.scrollToBottom();
                      
                      // Show typing indicator
                      this.showTypingIndicator();
                      
                      // Get random thinking time
                      const thinkingTime = this.getRandomThinkingTime();
                      
                      // Add a delay before processing the answer to make conversation feel more organic
                      setTimeout(() => {
                        // Hide typing indicator before showing the response
                        this.hideTypingIndicator();
                        
                        // Process the answer and continue the flow
                        this.processAnswer(result.question.id, id);
                      }, thinkingTime);
                    });
                    answersDiv.appendChild(button);
                  });
                  
                  this.chatContainer.appendChild(answersDiv);
                  this.scrollToBottom();
                }
              } else {
                // No recommendations, just display the question normally
                this.displayQuestion(result.question);
              }
              
              // Always scroll to the bottom after processing
              this.scrollToBottom();
                    }
                } catch (error) {
            console.error("Process answer error:", error);
            this.showError("Error processing answer: " + error.message);
          }
        }

        // Process various system option types
        processSystemOptions(systemOptions) {
          if (!systemOptions) return;
          
          // This function is now handled in processAnswer for a more integrated approach
          // but we'll keep it for backward compatibility
          if (systemOptions.output_list && !document.querySelector('.product-recommendations')) {
            this.displayProductRecommendations(systemOptions.output_list);
                }
            }

            async restart() {
                if (!this.chatContainer) return;
                
          this.chatContainer.innerHTML = "";
                if (this.currentFlowId) {
                    await this.init(this.currentFlowId);
                } else {
                    this.collapseCard();
                }
            }

        // Format current date in Romanian
        formatRomanianDate() {
          const today = new Date();
          const day = today.getDate();
          
          const months = [
            "IANUARIE", "FEBRUARIE", "MARTIE", "APRILIE", "MAI", "IUNIE",
            "IULIE", "AUGUST", "SEPTEMBRIE", "OCTOMBRIE", "NOIEMBRIE", "DECEMBRIE"
          ];
          
          const month = months[today.getMonth()];
          const year = today.getFullYear();
          
          return `${day} ${month} ${year}`;
        }
        
        // Add date header to the conversation
        addDateHeader() {
          if (!this.chatContainer) return;
          
          // Create date header element
          const dateHeader = document.createElement("div");
          dateHeader.className = "date-header";
          dateHeader.textContent = this.formatRomanianDate();
          
          // Add to the beginning of the chat container
          if (this.chatContainer.firstChild) {
            this.chatContainer.insertBefore(dateHeader, this.chatContainer.firstChild);
          } else {
            this.chatContainer.appendChild(dateHeader);
          }
        }

        // Helper function to scroll to the bottom of the chat
        scrollToBottom() {
          if (this.chatContainer) {
            // Use setTimeout to ensure this happens after DOM updates
            setTimeout(() => {
              this.chatContainer.scrollTo({
                top: this.chatContainer.scrollHeight,
                behavior: 'smooth'
              });
            }, 100);
          }
        }

        // Show a temporary small loading indicator to simulate typing
        showTypingIndicator() {
          if (!this.chatContainer) return;
          
          // Remove any existing indicator first
          this.hideLoading();
          
          const loadingDiv = document.createElement("div");
          loadingDiv.className = "typing-indicator system-message";
          loadingDiv.id = "typing-indicator";
          
          // Create the typing animation dots
          const dotsContainer = document.createElement("div");
          dotsContainer.className = "typing-dots";
          
          // Add 3 dots for animation
          for (let i = 0; i < 3; i++) {
            const dot = document.createElement("span");
            dot.className = "typing-dot";
            dotsContainer.appendChild(dot);
          }
          
          loadingDiv.appendChild(dotsContainer);
          this.chatContainer.appendChild(loadingDiv);
          this.scrollToBottom();
        }
        }

        // Initialize the chat on page load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, creating ChatbotInterface");
        window.chatbotInterface = new ChatbotInterface({
          headerTitle: "Bună ziua! Cu ce vǎ putem ajuta?",
        });
        });
    </script>
</body>
</html>
